<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minutagem Evolution | Scout V5.1</title>
    
    <meta name="theme-color" content="#09090b">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            /* TEMA MODERN ZINC (Vercel/Clean Dark Style) */
            --bg-body: #09090b; 
            --bg-card: #18181b; 
            --bg-sub:  #27272a; 
            --text-main: #e4e4e7; 
            --text-muted: #a1a1aa; 
            --accent: #22d3ee; 
            --border-color: #27272a; 
            
            --win: #34d399;  
            --draw: #fbbf24; 
            --loss: #f87171; 
            
            /* Cores do Gráfico (Evolução Temporal) */
            --chart-1-bg: #004db9; --chart-1-bd: #004db9;
            --chart-2-bg: #a50003;  --chart-2-bd: #a50003;
            --chart-3-bg: #00ff2f;  --chart-3-bd: #00ff2f;
        }

        body.light-mode {
            --bg-body: #f8fafc; --bg-card: #ffffff; --bg-sub: #f1f5f9;
            --text-main: #0f172a; --text-muted: #64748b; --accent: #0284c7;
            --border-color: #e2e8f0;
            --win: #10b981; --draw: #d97706; --loss: #ef4444;
            --chart-1-bg: #004db9; --chart-1-bd: #004db9;
            --chart-2-bg: #a50003;  --chart-2-bd: #a50003;
            --chart-3-bg: #00ff2f;  --chart-3-bd: #00ff2f;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); padding: 20px; min-height: 100vh; transition: 0.3s; }
        .container { max-width: 1400px; margin: 0 auto; }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
        header h1 { font-family: 'Outfit', sans-serif; font-size: 1.5rem; font-weight: 700; letter-spacing: -0.5px; }
        header span.highlight { color: var(--accent); }
        .theme-btn { background: var(--bg-sub); border: 1px solid var(--border-color); color: var(--text-main); width: 40px; height: 40px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }

        /* Layout */
        .dashboard-grid { display: grid; grid-template-columns: 320px 1fr; gap: 25px; align-items: start; }
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }

        /* Sidebar */
        .sidebar { background: var(--bg-card); padding: 20px; border-radius: 20px; border: 1px solid var(--border-color); position: sticky; top: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        .mode-tabs { display: flex; background: var(--bg-sub); padding: 4px; border-radius: 12px; margin-bottom: 25px; }
        .mode-tab { flex: 1; padding: 10px; border: none; background: transparent; color: var(--text-muted); font-weight: 600; font-size: 0.9rem; cursor: pointer; border-radius: 10px; transition: 0.3s; }
        .mode-tab.active { background: var(--bg-card); color: var(--text-main); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .control-group { margin-bottom: 20px; }
        .control-group label { display: block; color: var(--text-muted); font-size: 0.75rem; margin-bottom: 8px; font-weight: 700; text-transform: uppercase; }
        select { width: 100%; background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border-color); padding: 12px; border-radius: 10px; font-size: 0.95rem; cursor: pointer; appearance: none; }
        
        .view-toggle { display: flex; gap: 10px; margin-top: 25px; }
        .toggle-btn { flex: 1; border: 1px solid var(--border-color); background: transparent; color: var(--text-muted); padding: 10px; cursor: pointer; border-radius: 10px; font-weight: 600; font-size: 0.85rem; transition: 0.2s; }
        .toggle-btn.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 700; }

        /* Main Content */
        .main-stage { display: none; opacity: 0; transition: opacity 0.4s ease-in-out; }

        .insights-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .insight-card { background: var(--bg-card); padding: 20px; border-radius: 16px; border: 1px solid var(--border-color); }
        .insight-label { color: var(--text-muted); font-size: 0.85rem; font-weight: 500; margin-bottom: 5px; }
        .insight-val { font-family: 'Outfit', sans-serif; font-size: 2rem; font-weight: 700; color: var(--text-main); }
        .insight-desc { font-size: 0.8rem; color: var(--accent); margin-top: 5px; }

        .chart-wrapper { background: var(--bg-card); padding: 20px; border-radius: 20px; border: 1px solid var(--border-color); height: 500px; position: relative; margin-bottom: 30px; }

        .stats-section-title { font-family: 'Outfit', sans-serif; font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--text-main); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 30px; }
        
        .advanced-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-box { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; }
        .stat-box h4 { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px; font-weight: 700; text-transform: uppercase; }
        
        .stat-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .stat-table td { padding: 8px 0; border-bottom: 1px dashed var(--border-color); }
        .stat-table tr:last-child td { border-bottom: none; }
        .stat-table .val-right { text-align: right; font-weight: 700; font-family: 'Outfit'; }
        
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 700; }
        .tag-win { background: rgba(52, 211, 153, 0.1); color: var(--win); }
        .tag-draw { background: rgba(251, 191, 36, 0.1); color: var(--draw); }
        .tag-loss { background: rgba(248, 113, 113, 0.1); color: var(--loss); }

        .mini-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .mini-card { background: var(--bg-card); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--border-color); transition: transform 0.2s; }
        .mini-card:hover { transform: translateY(-2px); border-color: var(--text-muted); }
        .mini-val { font-size: 1.4rem; font-weight: 800; font-family: 'Outfit'; margin: 5px 0; }

        .loader-overlay { position: absolute; inset: 0; background: var(--bg-card); opacity: 0.95; z-index: 50; display: none; flex-direction: column; align-items: center; justify-content: center; border-radius: 20px; }
        .loader-bar { width: 120px; height: 4px; background: var(--bg-sub); border-radius: 2px; overflow: hidden; margin-top: 15px; }
        .loader-progress { width: 50%; height: 100%; background: var(--accent); animation: load 1s infinite cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes load { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div style="display: flex; align-items: center;">
            <h1>Scout<span class="highlight">Vision</span></h1>
            <div style="margin-left: 15px; background: var(--bg-sub); padding: 5px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); border: 1px solid var(--border-color);">V5.1</div>
        </div>
        <button class="theme-btn" onclick="toggleTheme()" id="themeBtn">
            <i class="fas fa-moon"></i>
        </button>
    </header>

    <div class="dashboard-grid">
        <aside class="sidebar">
            
            <div class="mode-tabs">
                <button class="mode-tab active" id="tabLeague" onclick="setMode('league')">Liga</button>
                <button class="mode-tab" id="tabClub" onclick="setMode('club')">Clube</button>
            </div>

            <div class="control-group">
                <label>1. Selecione a Competição</label>
                <select id="leagueSelect"><option disabled selected>Carregando...</option></select>
            </div>
            
            <div class="control-group" id="teamSelectGroup">
                <label>2. Selecione o Clube</label>
                <select id="teamSelect" disabled><option>Aguardando...</option></select>
            </div>
            
            <div class="view-toggle">
                <button class="toggle-btn active" onclick="switchView('marcados')">Gols Pró</button>
                <button class="toggle-btn" onclick="switchView('sofridos')">Gols Contra</button>
            </div>
            
            <div style="margin-top:25px; padding-top:20px; border-top:1px solid var(--border-color); font-size:0.8rem; color:var(--text-muted); line-height:1.5;">
                <p id="modeDesc"><i class="fas fa-globe"></i> <strong>Modo Liga:</strong> Visão macro do campeonato.</p>
            </div>
        </aside>

        <main id="mainContent" class="main-stage">
            <div class="insights-row">
                <div class="insight-card">
                    <div class="insight-label">Momento Crítico</div>
                    <div class="insight-val" id="patternTime">--</div>
                    <div class="insight-desc" id="patternDesc">--</div>
                </div>
                <div class="insight-card">
                    <div class="insight-label" id="bestYearLabel">Melhor Temporada</div>
                    <div class="insight-val" id="bestYear">--</div>
                    <div class="insight-desc" id="bestYearDesc">--</div>
                </div>
            </div>

            <div class="chart-wrapper">
                <canvas id="goalsChart"></canvas>
                <div id="loader" class="loader-overlay">
                    <div style="font-weight:700; font-family:'Outfit';">Processando...</div>
                    <div class="loader-bar"><div class="loader-progress"></div></div>
                </div>
            </div>

            <div class="stats-section-title"><i class="fas fa-chart-pie"></i> Análise de Desempenho</div>
            <div class="advanced-grid" id="advancedStats"></div>

            <div class="stats-section-title"><i class="fas fa-history"></i> Histórico Recente</div>
            <div class="mini-grid" id="statsGrid"></div>
        </main>
    </div>
</div>

<script>
    // ==========================================
    // 0. SYSTEM & THEME
    // ==========================================
    window.onerror = function(msg, url, line) {
        const sel = document.getElementById('leagueSelect');
        if(sel) {
            sel.innerHTML = `<option>Erro JS (Linha ${line})</option>`;
            alert("Erro no Script: " + msg);
        }
    };

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js'));
    }

    if (!localStorage.getItem('theme')) localStorage.setItem('theme', 'dark');
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') { document.body.classList.add('light-mode'); updateIcon(true); }
    else { updateIcon(false); }

    function toggleTheme() {
        const isLight = document.body.classList.toggle('light-mode');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
        updateIcon(isLight);
        renderDashboard(); 
    }
    function updateIcon(isLight) {
        document.getElementById('themeBtn').innerHTML = isLight ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
    }

    // ==========================================
    // 1. DADOS
    // ==========================================
    const dataSources = {
        'África do Sul (Premier Soccer League)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/South%20Africa%20Premier%20Soccer%20League_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/South%20Africa%20Premier%20Soccer%20League_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/South%20Africa%20Premier%20Soccer%20League_20252026.xlsx' }
        ]
        'Alemanha (Bundesliga)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Germany%20Bundesliga_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Germany%20Bundesliga_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Germany%20Bundesliga_20252026.xlsx' }
        ],
        'Alemanha (2. Bundesliga)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Germany%202.%20Bundesliga_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Germany%202.%20Bundesliga_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Germany%202.%20Bundesliga_20252026.xlsx' }
        ],
        'Arábia Saudita (Pro League)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Saudi%20Arabia%20Professional%20League_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Saudi%20Arabia%20Professional%20League_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Saudi%20Arabia%20Professional%20League_20252026.xlsx' }
        ],
        'Austrália (A-League)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Australia%20A-League_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Australia%20A-League_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Australia%20A-League_20252026.xlsx' }
        ],
        'Áustria (Bundesliga)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Austria%20Bundesliga_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Austria%20Bundesliga_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Austria%20Bundesliga_20252026.xlsx' }
        ],
        'Bélgica (Pro League)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Belgium%20Pro%20League_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Belgium%20Pro%20League_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Belgium%20Pro%20League_20252026.xlsx' }
        ],
        'Brasil (Série A)': [
            { year: '2023', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Brazil%20Serie%20A_2023.xlsx' },
            { year: '2024', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Brazil%20Serie%20A_2024.xlsx' },
            { year: '2025', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Brazil%20Serie%20A_2025.xlsx' }
        ],
        'Brasil (Série B)': [
            { year: '2023', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Brazil%20Serie%20B_2023.xlsx' },
            { year: '2024', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Brazil%20Serie%20B_2024.xlsx' },
            { year: '2025', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Brazil%20Serie%20B_2025.xlsx' }
        ],
        'Brasil (Série C)': [
            { year: '2023', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Brazil%20Serie%20C_2023.xlsx' },
            { year: '2024', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Brazil%20Serie%20C_2024.xlsx' },
            { year: '2025', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Brazil%20Serie%20C_2025.xlsx' }
        ],
        'Chile (Primera División)': [
            { year: '2023', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Chile%20Primera%20Divisi%C3%B3n_2023.xlsx' },
            { year: '2024', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Chile%20Primera%20Divisi%C3%B3n_2024.xlsx' },
            { year: '2025', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Chile%20Primera%20Divisi%C3%B3n_2025.xlsx' }
        ],
        'China (Super League)': [
            { year: '2023', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/China%20Chinese%20Super%20League_2023.xlsx' },
            { year: '2024', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/China%20Chinese%20Super%20League_2024.xlsx' },
            { year: '2025', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/China%20Chinese%20Super%20League_2025.xlsx' }
        ],
        'Coreia do Sul (K-League 1)': [
            { year: '2023', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/South%20Korea%20K%20League%201_2023.xlsx' },
            { year: '2024', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/South%20Korea%20K%20League%201_2024.xlsx' },
            { year: '2025', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/South%20Korea%20K%20League%201_2025.xlsx' }
        ],
        'Coreia do Sul (K-League 2)': [
            { year: '2023', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/South%20Korea%20K%20League%202_2023.xlsx' },
            { year: '2024', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/South%20Korea%20K%20League%202_2024.xlsx' },
            { year: '2025', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/South%20Korea%20K%20League%202_2025.xlsx' }
        ],
        'Croácia (Prva HNL)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Croatia%20Prva%20HNL_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Croatia%20Prva%20HNL_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Croatia%20Prva%20HNL_20252026.xlsx' }
        ],
        'Dinamarca (Superliga)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Denmark%20Superliga_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Denmark%20Superliga_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Denmark%20Superliga_20252026.xlsx' }
        ],
        'Egito (Premier League)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Egypt%20Egyptian%20Premier%20League_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Egypt%20Egyptian%20Premier%20League_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Egypt%20Egyptian%20Premier%20League_20252026.xlsx' }
        ],
        'Escócia (Premiership)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Scotland%20Premiership_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Scotland%20Premiership_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Scotland%20Premiership_20252026.xlsx' }
        ],
        'Eslováquia (Super Liga)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Slovakia%20Super%20Liga_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Slovakia%20Super%20Liga_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Slovakia%20Super%20Liga_20252026.xlsx' }
        ],
        'Eslovênia (PrvaLiga)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Slovenia%20PrvaLiga_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Slovenia%20PrvaLiga_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Slovenia%20PrvaLiga_20252026.xlsx' }
        ],
        'Espanha (La Liga)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Spain%20La%20Liga_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Spain%20La%20Liga_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Spain%20La%20Liga_20252026.xlsx' }
        ],
        'Espanha (Segunda División)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Spain%20Segunda%20Divisi%C3%B3n_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Spain%20Segunda%20Divisi%C3%B3n_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Spain%20Segunda%20Divisi%C3%B3n_20252026.xlsx' }
        ],
        'EUA (MLS)': [
            { year: '2023', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/USA%20MLS_2023.xlsx' },
            { year: '2024', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/USA%20MLS_2024.xlsx' },
            { year: '2025', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/USA%20MLS_2025.xlsx' }
        ],
        'França (Ligue 1)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/France%20Ligue%201_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/France%20Ligue%201_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/France%20Ligue%201_20252026.xlsx' }
        ],
        'França (Ligue 2)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/France%20Ligue%202_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/France%20Ligue%202_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/France%20Ligue%202_20252026.xlsx' }
        ],
        'França (National)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/France%20National_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/France%20National_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/France%20National_20252026.xlsx' }
        ],
        'Grécia (Super League)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Greece%20Super%20League_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Greece%20Super%20League_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Greece%20Super%20League_20252026.xlsx' }
        ],
        'Holanda (Eredivisie)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Netherlands%20Eredivisie_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Netherlands%20Eredivisie_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Netherlands%20Eredivisie_20252026.xlsx' }
        ],
        'Holanda (Eerste Divisie)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Netherlands%20Eerste%20Divisie_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Netherlands%20Eerste%20Divisie_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Netherlands%20Eerste%20Divisie_20252026.xlsx' }
        ],
        'Inglaterra (Premier League)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/England%20Premier%20League_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/England%20Premier%20League_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/England%20Premier%20League_20252026.xlsx' }
        ],
        'Inglaterra (Championship)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/England%20Championship_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/England%20Championship_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/England%20Championship_20252026.xlsx' }
        ],
        'Israel (Premier League)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Israel%20Israeli%20Premier%20League_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Israel%20Israeli%20Premier%20League_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Israel%20Israeli%20Premier%20League_20252026.xlsx' }
        ],
        'Itália (Serie A)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Italy%20Serie%20A_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Italy%20Serie%20A_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Italy%20Serie%20A_20252026.xlsx' }
        ],
        'Itália (Serie B)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Italy%20Serie%20B_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Italy%20Serie%20B_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Italy%20Serie%20B_20252026.xlsx' }
        ],
        'Japão (J1 League)': [
            { year: '2023', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Japan%20J1%20League_2023.xlsx' },
            { year: '2024', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Japan%20J1%20League_2024.xlsx' },
            { year: '2025', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Japan%20J1%20League_2025.xlsx' }
        ],
        'Noruega (Eliteserien)': [
            { year: '2023', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Norway%20Eliteserien_2023.xlsx' },
            { year: '2024', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Norway%20Eliteserien_2024.xlsx' },
            { year: '2025', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Norway%20Eliteserien_2025.xlsx' }
        ],
        'Polônia (Ekstraklasa)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Poland%20Ekstraklasa_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Poland%20Ekstraklasa_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Poland%20Ekstraklasa_20252026.xlsx' }
        ],
        'Portugal (Liga NOS)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Portugal%20Liga%20NOS_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Portugal%20Liga%20NOS_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Portugal%20Liga%20NOS_20252026.xlsx' }
        ],
        'Portugal (LigaPro)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Portugal%20LigaPro_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Portugal%20LigaPro_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Portugal%20LigaPro_20252026.xlsx' }
        ],
        'República Tcheca (First League)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Czech%20Republic%20First%20League_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Czech%20Republic%20First%20League_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Czech%20Republic%20First%20League_20252026.xlsx' }
        ],
        'Romênia (Liga I)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Romania%20Liga%20I_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Romania%20Liga%20I_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Romania%20Liga%20I_20252026.xlsx' }
        ],
        'Sérvia (SuperLiga)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Serbia%20SuperLiga_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Serbia%20SuperLiga_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Serbia%20SuperLiga_20252026.xlsx' }
        ],
        'Suécia (Allsvenskan)': [
            { year: '2023', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Sweden%20Allsvenskan_2023.xlsx' },
            { year: '2024', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Sweden%20Allsvenskan_2024.xlsx' },
            { year: '2025', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Sweden%20Allsvenskan_2025.xlsx' }
        ],
        'Suíça (Super League)': [
            { year: '23/24', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Switzerland%20Super%20League_20232024.xlsx' },
            { year: '24/25', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Switzerland%20Super%20League_20242025.xlsx' },
            { year: '25/26', url: 'https://raw.githubusercontent.com/futpythontrader/YouTube/main/Bases_de_Dados/FootyStats/Switzerland%20Super%20League_20252026.xlsx' }
        ]
    };
    
    let repository = {};
    let chartInstance = null;
    let currentTeam = '';
    let currentView = 'marcados';
    let currentMode = 'league'; // DEFAULT ALTERADO PARA LIGA

    // ==========================================
    // 2. INICIALIZAÇÃO E NAVEGAÇÃO
    // ==========================================
    function setMode(mode) {
        currentMode = mode;
        
        document.querySelectorAll('.mode-tab').forEach(b => b.classList.remove('active'));
        document.getElementById(mode === 'club' ? 'tabClub' : 'tabLeague').classList.add('active');

        const teamSel = document.getElementById('teamSelect');
        const teamGroup = document.getElementById('teamSelectGroup');
        const desc = document.getElementById('modeDesc');

        if (mode === 'league') {
            teamSel.disabled = true;
            teamGroup.style.opacity = '0.5';
            desc.innerHTML = '<i class="fas fa-globe"></i> <strong>Modo Liga:</strong> Visão macro do campeonato.';
        } else {
            teamSel.disabled = false;
            teamGroup.style.opacity = '1';
            desc.innerHTML = '<i class="fas fa-shield-alt"></i> <strong>Modo Clube:</strong> Analise o desempenho individual.';
        }
        renderDashboard();
    }

    function switchView(type) {
        currentView = type;
        document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        renderDashboard();
    }

    // ==========================================
    // 3. CARREGAMENTO E PARSING
    // ==========================================
    function findValue(row, keys) {
        for (let key of keys) {
            if (row[key] !== undefined) return row[key];
        }
        return 0;
    }

    window.onload = () => {
        const sel = document.getElementById('leagueSelect');
        
        // ORDENAÇÃO DE LIGAS (A-Z)
        const sortedLeagues = Object.keys(dataSources).sort();
        
        sortedLeagues.forEach(key => {
            const opt = document.createElement('option');
            opt.value = key; opt.textContent = key; sel.appendChild(opt);
        });
        
        sel.addEventListener('change', loadData);
        document.getElementById('teamSelect').addEventListener('change', (e) => {
            currentTeam = e.target.value;
            renderDashboard();
        });

        // Configuração Inicial: Modo Liga
        setMode('league');
    };

    async function loadData(e) {
        const region = e.target.value;
        const loader = document.getElementById('loader');
        const teamSel = document.getElementById('teamSelect');
        const main = document.getElementById('mainContent');

        loader.style.display = 'flex';
        teamSel.innerHTML = '<option>Carregando...</option>';
        teamSel.disabled = true;
        main.style.opacity = '0';
        repository = {}; 

        try {
            const requests = dataSources[region].map(src => 
                fetch(src.url).then(r => r.arrayBuffer()).then(buf => {
                    const wb = XLSX.read(buf, {type:'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    return { year: src.year, data: json };
                })
            );

            const results = await Promise.all(requests);
            
            const allTeams = new Set();
            results.forEach(res => {
                repository[res.year] = res.data.map(row => {
                    const h = findValue(row, ['Home Team', 'HomeTeam', 'Home', 'home_team_name']);
                    const a = findValue(row, ['Away Team', 'AwayTeam', 'Away', 'away_team_name']);
                    
                    if(h && h !== 0) allTeams.add(h);
                    if(a && a !== 0) allTeams.add(a);

                    const fthg = Number(findValue(row, ['home_team_goal_count', 'FTHG', 'Home Team Goal Count', 'Goals_H_FT'])) || 0;
                    const ftag = Number(findValue(row, ['away_team_goal_count', 'FTAG', 'Away Team Goal Count', 'Goals_A_FT'])) || 0;
                    const hthg = Number(findValue(row, ['home_team_goal_count_half_time', 'HTHG', 'Home Team Goal Count Half Time', 'Goals_H_HT'])) || 0;
                    const htag = Number(findValue(row, ['away_team_goal_count_half_time', 'HTAG', 'Away Team Goal Count Half Time', 'Goals_A_HT'])) || 0;

                    return {
                        Home: h, Away: a,
                        Goals_H_Mins: row.Goals_H_Minutes || "",
                        Goals_A_Mins: row.Goals_A_Minutes || "",
                        FTHG: fthg, FTAG: ftag,
                        HTHG: hthg, HTAG: htag
                    };
                });
            });

            teamSel.innerHTML = '<option value="" disabled selected>Escolha um clube</option>';
            
            // ORDENAÇÃO DE CLUBES (A-Z)
            [...allTeams].sort().forEach(t => {
                const op = document.createElement('option');
                op.value = t; op.textContent = t; teamSel.appendChild(op);
            });
            
            // Reabilita seleção apenas se estiver no modo clube
            if (currentMode === 'club') teamSel.disabled = false;
            
            // Renderiza sempre (para modo liga funcionar direto)
            renderDashboard();

        } catch (err) {
            alert('Erro: ' + err.message);
        } finally {
            loader.style.display = 'none';
        }
    }

    // ==========================================
    // 4. STATS LOGIC
    // ==========================================
    function calculateStats(matches, mode, teamName) {
        let s = {
            total: 0,
            ft: { homeWin: 0, draw: 0, awayWin: 0, over05: 0, over15: 0, over25: 0, z0x0: 0, goals: 0 },
            ht: { homeWin: 0, draw: 0, awayWin: 0, over05: 0, over15: 0, over25: 0, z0x0: 0, goals: 0 },
            wins: 0, draws: 0, losses: 0 
        };

        matches.forEach(m => {
            s.total++;
            const ftG = m.FTHG + m.FTAG;
            const htG = m.HTHG + m.HTAG;
            s.ft.goals += ftG; s.ht.goals += htG;

            if(m.FTHG > m.FTAG) s.ft.homeWin++; else if(m.FTHG < m.FTAG) s.ft.awayWin++; else s.ft.draw++;
            if(ftG > 0.5) s.ft.over05++; if(ftG > 1.5) s.ft.over15++; if(ftG > 2.5) s.ft.over25++;
            if(ftG === 0) s.ft.z0x0++;

            if(m.HTHG > m.HTAG) s.ht.homeWin++; else if(m.HTHG < m.HTAG) s.ht.awayWin++; else s.ht.draw++;
            if(htG > 0.5) s.ht.over05++; if(htG > 1.5) s.ht.over15++;
            if(htG === 0) s.ht.z0x0++;

            if (mode === 'club') {
                const isHome = m.Home === teamName;
                const myG = isHome ? m.FTHG : m.FTAG;
                const oppG = isHome ? m.FTAG : m.FTHG;
                if(myG > oppG) s.wins++; else if(myG < oppG) s.losses++; else s.draws++;
            }
        });
        return s;
    }

    // ==========================================
    // 5. RENDERIZAÇÃO
    // ==========================================
    function renderDashboard() {
        const main = document.getElementById('mainContent');
        const advancedDiv = document.getElementById('advancedStats');
        const statsGrid = document.getElementById('statsGrid');
        
        if (currentMode === 'club' && !currentTeam) return;
        if (Object.keys(repository).length === 0) return;

        main.style.display = 'block';
        setTimeout(() => main.style.opacity = '1', 50);

        const labels = ['0-10', '11-20', '21-30', '31-40', '41-50', '51-60', '61-70', '71-80', '81-90', '90+'];
        const datasets = [];
        let allMinutes = [];
        let yearStats = [];
        
        const getStyle = (idx, total) => {
            const themeIdx = (idx % 3) + 1; 
            return {
                bg: getComputedStyle(document.body).getPropertyValue(`--chart-${themeIdx}-bg`),
                bd: getComputedStyle(document.body).getPropertyValue(`--chart-${themeIdx}-bd`)
            };
        };

        let relevantMatches = [];
        const sortedYears = Object.keys(repository).sort(); 

        sortedYears.forEach((year, idx) => {
            const matches = repository[year];
            let filtered = [];

            if (currentMode === 'club') {
                const h = matches.filter(m => m.Home === currentTeam);
                const a = matches.filter(m => m.Away === currentTeam);
                filtered = [...h, ...a];
            } else {
                filtered = matches;
            }

            if (filtered.length === 0) return;
            relevantMatches.push(...filtered);

            let minutes = [];
            filtered.forEach(m => {
                if (currentMode === 'league') {
                    minutes.push(...getMinutes(m.Goals_H_Mins));
                    minutes.push(...getMinutes(m.Goals_A_Mins));
                } else {
                    const isHome = m.Home === currentTeam;
                    if (currentView === 'marcados') minutes.push(...getMinutes(isHome ? m.Goals_H_Mins : m.Goals_A_Mins));
                    else minutes.push(...getMinutes(isHome ? m.Goals_A_Mins : m.Goals_H_Mins));
                }
            });

            allMinutes.push(...minutes);
            yearStats.push({ year, count: minutes.length });

            const bins = new Array(10).fill(0);
            minutes.forEach(m => {
                let bin = Math.floor((m-1)/10);
                if (bin < 0) bin = 0; if (bin > 9) bin = 9;
                bins[bin]++;
            });

            const style = getStyle(idx, sortedYears.length);

            datasets.push({
                label: year,
                data: bins,
                backgroundColor: style.bg,
                borderColor: style.bd,
                borderWidth: 2,
                borderRadius: 4,
                datalabels: { align: 'end', anchor: 'end' }
            });
        });

        updateChart(labels, datasets);
        generateInsights(allMinutes, yearStats);
        
        const s = calculateStats(relevantMatches, currentMode, currentTeam);
        const t = s.total || 1;
        const pct = (v) => ((v/t)*100).toFixed(0) + '%';
        
        let html = '';

        if (currentMode === 'league') {
            html += `
            <div class="stat-box">
                <h4>Mandante x Visitante (FT)</h4>
                <table class="stat-table">
                    <tr><td>Vitória Mandante</td><td class="val-right"><span class="tag tag-win">${pct(s.ft.homeWin)}</span></td></tr>
                    <tr><td>Empate</td><td class="val-right"><span class="tag tag-draw">${pct(s.ft.draw)}</span></td></tr>
                    <tr><td>Vitória Visitante</td><td class="val-right"><span class="tag tag-loss">${pct(s.ft.awayWin)}</span></td></tr>
                </table>
            </div>
            <div class="stat-box">
                <h4>Intervalo (HT)</h4>
                <table class="stat-table">
                    <tr><td>Vitória Casa</td><td class="val-right">${pct(s.ht.homeWin)}</td></tr>
                    <tr><td>Empate</td><td class="val-right">${pct(s.ht.draw)}</td></tr>
                    <tr><td>Vitória Fora</td><td class="val-right">${pct(s.ht.awayWin)}</td></tr>
                    <tr><td style="color:var(--text-muted)">0x0 HT</td><td class="val-right">${pct(s.ht.z0x0)}</td></tr>
                </table>
            </div>
            <div class="stat-box">
                <h4>Mercado Gols (FT)</h4>
                <table class="stat-table">
                    <tr><td>Over 0.5</td><td class="val-right">${pct(s.ft.over05)}</td></tr>
                    <tr><td>Over 1.5</td><td class="val-right">${pct(s.ft.over15)}</td></tr>
                    <tr><td>Over 2.5</td><td class="val-right">${pct(s.ft.over25)}</td></tr>
                    <tr><td style="color:var(--text-muted)">0x0 FT</td><td class="val-right">${pct(s.ft.z0x0)}</td></tr>
                </table>
            </div>
            <div class="stat-box">
                <h4>Mercado Gols (HT)</h4>
                <table class="stat-table">
                    <tr><td>Over 0.5 HT</td><td class="val-right">${pct(s.ht.over05)}</td></tr>
                    <tr><td>Over 1.5 HT</td><td class="val-right">${pct(s.ht.over15)}</td></tr>
                </table>
            </div>`;
        } else {
            html += `
            <div class="stat-box">
                <h4>Raio-X (Resultados)</h4>
                <table class="stat-table">
                    <tr><td>Vitórias</td><td class="val-right"><span class="tag tag-win">${s.wins} (${pct(s.wins)})</span></td></tr>
                    <tr><td>Empates</td><td class="val-right"><span class="tag tag-draw">${s.draws} (${pct(s.draws)})</span></td></tr>
                    <tr><td>Derrotas</td><td class="val-right"><span class="tag tag-loss">${s.losses} (${pct(s.losses)})</span></td></tr>
                    <tr><td>Jogos</td><td class="val-right">${s.total}</td></tr>
                </table>
            </div>
             <div class="stat-box">
                <h4>Gols & Mercados (FT)</h4>
                <table class="stat-table">
                    <tr><td>Over 0.5</td><td class="val-right">${pct(s.ft.over05)}</td></tr>
                    <tr><td>Over 1.5</td><td class="val-right">${pct(s.ft.over15)}</td></tr>
                    <tr><td>Over 2.5</td><td class="val-right">${pct(s.ft.over25)}</td></tr>
                    <tr><td>0x0 FT</td><td class="val-right">${pct(s.ft.z0x0)}</td></tr>
                </table>
            </div>
            <div class="stat-box">
                <h4>Intervalo (HT)</h4>
                <table class="stat-table">
                    <tr><td>Over 0.5 HT</td><td class="val-right">${pct(s.ht.over05)}</td></tr>
                    <tr><td>0x0 HT</td><td class="val-right">${pct(s.ht.z0x0)}</td></tr>
                </table>
            </div>
            `;
        }

        advancedDiv.innerHTML = html;

        statsGrid.innerHTML = '';
        yearStats.forEach((stat, i) => {
            const themeIdx = (i % 3) + 1;
            const color = getComputedStyle(document.body).getPropertyValue(`--chart-${themeIdx}-bd`);
            statsGrid.innerHTML += `
                <div class="mini-card" style="border-top: 3px solid ${color}">
                    <span style="font-size:0.8rem; opacity:0.7; color:${color}">${stat.year}</span>
                    <div class="mini-val">${stat.count}</div>
                    <div style="font-size:0.7rem; color:var(--text-muted)">Gols</div>
                </div>
            `;
        });
    }

    function getMinutes(str) {
        if (!str) return [];
        return String(str).replace(/[\[\]']/g, '').split(',').map(s => {
            s = s.trim(); if(!s) return null;
            if(s.includes('+')) { const [a,b] = s.split('+'); return Math.min(parseInt(a)+parseInt(b), 95); }
            return parseInt(s);
        }).filter(n => n !== null && !isNaN(n));
    }

    function updateChart(labels, datasets) {
        const ctx = document.getElementById('goalsChart').getContext('2d');
        const isLight = document.body.classList.contains('light-mode');
        const textColor = isLight ? '#475569' : '#a1a1aa';
        const gridColor = isLight ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.05)';

        if (chartInstance) chartInstance.destroy();
        Chart.register(ChartDataLabels);

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { right: 30 } },
                plugins: {
                    legend: { labels: { color: textColor, font: {family: 'Inter', size: 12} } },
                    tooltip: { 
                        mode: 'index', intersect: false, 
                        backgroundColor: isLight ? '#fff' : '#18181b',
                        titleColor: isLight ? '#000' : '#fff', 
                        bodyColor: textColor, 
                        borderColor: gridColor, borderWidth: 1
                    },
                    datalabels: {
                        color: textColor, font: { weight: '700', size: 11 },
                        formatter: (v) => v > 0 ? v : '', anchor: 'end', align: 'end', offset: 4
                    }
                },
                scales: {
                    x: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } },
                    y: { grid: { display: false }, ticks: { color: textColor, font: { weight: '600' } } }
                }
            }
        });
    }

    function generateInsights(allMinutes, yearStats) {
        const bins = new Array(10).fill(0);
        allMinutes.forEach(m => {
            let idx = Math.floor((m-1)/10);
            if(idx > 9) idx = 9; if(idx < 0) idx = 0; bins[idx]++;
        });
        const maxVal = Math.max(...bins);
        const maxIdx = bins.indexOf(maxVal);
        const range = maxIdx === 9 ? "90+" : `${maxIdx*10+1}-${(maxIdx+1)*10}`;
        const pct = allMinutes.length ? ((maxVal/allMinutes.length)*100).toFixed(1) : 0;

        document.getElementById('patternTime').innerHTML = `${range}<small style="font-size:1rem">'</small>`;
        document.getElementById('patternDesc').innerText = `Concentra ${pct}% dos gols.`;

        const best = yearStats.reduce((prev, current) => (prev.count > current.count) ? prev : current, {year:'-', count:0});
        document.getElementById('bestYear').innerText = best.year;
        
        const label = currentMode === 'league' ? 'Temporada + Gols' : 'Melhor Temporada';
        document.getElementById('bestYearLabel').innerText = label;
        document.getElementById('bestYearDesc').innerText = `${best.count} gols totais.`;
    }
</script>
</body>
</html>
